{% extends "base.html" %}
{% block title %}Nurse Dashboard - Medi-Assistâ„¢{% endblock %}
{% block content %}
<div class="container mx-auto px-4 py-8 nurse-wrapper">
    <h2 class="text-3xl font-bold mb-8 nurse-welcome">Nurse Dashboard</h2>

    <!-- System Overview -->
    <details class="bg-white rounded-lg shadow-md p-6 mb-8 overview-panel">
        <summary class="text-xl font-semibold cursor-pointer">System Overview</summary>
        <div class="panel-content mt-4">
            <ul class="space-y-2">
                <li>Today's Patients: <strong>{{ todays_patients }}</strong></li>
                <li>Total Assigned: <strong>{{ patients|length }}</strong></li>
                <li>Emergency Requests: <strong>{{ emergency_requests }}</strong></li>
                <li>New Messages: <strong>{{ new_messages }}</strong></li>
                <li>Current Shift: <strong>{{ shift_start }} - {{ shift_end }}</strong></li>
                <li>Hours Left in Shift: <strong>{{ shift_hours_left }}</strong></li>
            </ul>
        </div>
    </details>

    <!-- Today's Appointments -->
    <div class="bg-white rounded-lg shadow-md p-6 card mb-8">
        <header class="flex justify-between items-center mb-4">
            <h2 class="text-xl font-semibold">Today's Appointments</h2>
            <span class="text-gray-600">Total: {{ appointments|length }}</span>
        </header>
        {% if appointments %}
        <table class="w-full table-auto border-collapse table">
            <thead class="bg-gray-100">
                <tr>
                    <th class="px-4 py-2 text-left">Patient ID</th>
                    <th class="px-4 py-2 text-left">Name</th>
                    <th class="px-4 py-2 text-left">Appointment Time</th>
                    <th class="px-4 py-2 text-left">Reason</th>
                    <th class="px-4 py-2 text-left">Action</th>
                </tr>
            </thead>
            <tbody id="appointments-table-body">
                {% for appt in appointments %}
                <tr data-appointment-id="{{ appt.id }}" class="hover:bg-gray-50">
                    <td class="px-4 py-2">{{ appt.patient_id }}</td>
                    <td class="px-4 py-2">{{ appt.patient_name }}</td>
                    <td class="px-4 py-2">{{ appt.appointment_date }}</td>
                    <td class="px-4 py-2">{{ appt.reason or 'N/A' }}</td>
                    <td class="px-4 py-2">
                        <div class="action-buttons flex space-x-2">
                            <form onsubmit="markHelped(event, '{{ appt.id }}')" class="inline">
                                <input type="hidden" name="appointment_id" value="{{ appt.id }}">
                                <button type="submit" class="btn btn-success">Mark as Helped</button>
                            </form>
                            <a href="{{ url_for('nurse_assess_patient', patient_id=appt.patient_id) }}" class="btn btn-primary">Assess</a>
                            <a href="{{ url_for('nurse_view_medical_history', patient_id=appt.patient_id) }}" class="btn btn-info">History</a>
                            <a href="{{ url_for('nurse_prescribe_medication', patient_id=appt.patient_id) }}" class="btn btn-warning">Prescribe</a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="text-center text-gray-600 no-appointments">No appointments scheduled for today.</p>
        {% endif %}
    </div>

    <!-- Patient Care -->
    <div class="bg-white rounded-lg shadow-md p-6 card mb-8">
        <h3 class="text-xl font-semibold mb-4">Patient Care</h3>
        <p>
            {% if emergency_requests > 0 %}
            <a href="{{ url_for('emergency_homepage') }}" class="btn btn-alert">Emergency Requests ({{ emergency_requests }})</a>
            {% endif %}
        </p>
    </div>

    <!-- Messages & Shift -->
    <div class="bg-white rounded-lg shadow-md p-6 card">
        <h3 class="text-xl font-semibold mb-4">Messages & Shift</h3>
        <ul class="space-y-2">
            <li>New Messages: <strong>{{ new_messages }}</strong> <a href="{{ url_for('edit_profile') }}">Inbox</a></li>
            <li>Next Shift Ends: <strong>{{ shift_end }}</strong></li>
            <li>Hours Left: <strong>{{ shift_hours_left }}</strong></li>
        </ul>
    </div>

    <!-- Flash Messages -->
    <div id="flash-messages" class="mt-4">
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ category }}">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>
</div>

<script>
function markHelped(event, appointmentId) {
    event.preventDefault();
    const formData = new FormData();
    formData.append('appointment_id', appointmentId);
    const flashMessages = document.getElementById('flash-messages');

    fetch('/mark_helped', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        flashMessages.innerHTML = `<div class="alert alert-${data.category}">${data.message}</div>`;
        if (data.success) {
            const row = document.querySelector(`tr[data-appointment-id="${appointmentId}"]`);
            if (row) {
                row.remove();
                const tbody = document.getElementById('appointments-table-body');
                if (tbody.children.length === 0) {
                    tbody.insertAdjacentHTML('afterend', '<p class="no-appointments text-center text-gray-600">No appointments scheduled for today.</p>');
                }
            }
        }
    })
    .catch(error => {
        console.error('Error marking patient as helped:', error);
        flashMessages.innerHTML = '<div class="alert alert-error">Error marking patient as helped. Please try again.</div>';
    });
}

document.addEventListener('DOMContentLoaded', () => {
    const source = new EventSource('/stream_waiting_patients');

    source.onmessage = function(event) {
        try {
            const update = JSON.parse(event.data);
            console.log('Appointment update:', update);
            const row = document.querySelector(`tr[data-appointment-id="${update.id}"]`);
            if (update.status === 'helped' && row) {
                row.remove();
                const tbody = document.getElementById('appointments-table-body');
                if (tbody.children.length === 0) {
                    tbody.insertAdjacentHTML('afterend', '<p class="no-appointments text-center text-gray-600">No appointments scheduled for today.</p>');
                }
            }
        } catch (e) {
            console.error('Error processing SSE data:', e);
        }
    };

    source.onerror = function() {
        console.warn('SSE connection error. Reconnecting in 5 seconds...');
        source.close();
        setTimeout(() => {
            window.location.reload();
        }, 5000);
    };

    window.addEventListener('beforeunload', () => {
        source.close();
    });
});
</script>
{% endblock %}