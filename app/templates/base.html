<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{% block title %}Medi-Assist™ — Dashboard{% endblock %}</title>

  <!-- Icons + Styles -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/baseSidebar.css') }}?v=2">
  {% if session.role == 'receptionist' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reception.css') }}?v=2">
  {% elif session.role == 'doctor' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/doctor.css') }}?v=1">
  {% elif session.role == 'nurse' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/nurse.css') }}?v=1">
  {% elif session.role == 'admin' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}?v=1">
  {% elif session.role == 'manager' %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/manager.css') }}?v=2">
  {% endif %}
  {% block styles %}{% endblock %}

  <!-- CSRF Token for JS -->
  <meta name="csrf-token" content="{{ csrf_token() }}">

  <!-- === PERSISTENT THEME FROM localStorage === -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.dataset.theme = savedTheme;
    });
  </script>

  <!-- Update current-time CSS variable -->
  <style>
    :root {
      --current-time: "02:35 PM SAST, October 22, 2025";
    }
    @keyframes update-time {
      0% { --current-time: "00:00 AM SAST, January 1, 1970"; }
      100% { --current-time: "00:00 AM SAST, January 1, 1970"; }
    }
    :root { animation: update-time 1s infinite; }
  </style>

  <!-- Dynamic time injector -->
  <script>
    (function () {
      const now = new Date();
      const options = { hour: '2-digit', minute: '2-digit', hour12: true, timeZone: 'Africa/Johannesburg' };
      const timeStr = now.toLocaleString('en-ZA', options).replace(',', '') + ' SAST, ' +
                      now.toLocaleDateString('en-ZA', { year:'numeric', month:'long', day:'numeric' });
      document.documentElement.style.setProperty('--current-time', `"${timeStr}"`);
    })();
  </script>
</head>
<body class="dashboard-page" data-role="{{ session.role }}" data-user-id="{{ session.user_id or '' }}">
  <i class="fas fa-bars menu-icon" id="menu-toggle-btn"></i>

  <!-- Sidebar -->
  <aside class="sidebar {% if session.role == 'receptionist' %}active{% endif %}" id="sidebar" role="navigation" aria-label="Main Navigation">
    <div class="logo">ClinicCare</div>
    <nav>
      {% if session.username %}
        <div class="user-info">
          <img src="{{ url_for('static', filename=session.profile_image) }}" alt="User Avatar" id="sidebarAvatar">
          <span>{{ session.username }} ({{ session.role | capitalize }})</span>
        </div>

        <!-- RECEPTIONIST MENU -->
        {% if session.role == 'receptionist' %}
          <ul>
            <li><a href="{{ url_for('reception.reception_dashboard') }}" class="sidebar-btn">Dashboard</a></li>
            <li><a href="{{ url_for('reception.manage_appointments') }}" class="sidebar-btn">Manage Appointments</a></li>
            <li><a href="{{ url_for('reception.check_in_desk') }}" class="sidebar-btn">Check-In Desk</a></li>
            <li><a href="{{ url_for('reception.helped_patients_report') }}" class="sidebar-btn">Patient Report</a></li>
            <li><a href="{{ url_for('reception.search_patient') }}" class="sidebar-btn">Search Patients</a></li>
            <li><a href="{{ url_for('reception.view_announcements') }}" class="sidebar-btn">View Announcements</a></li>
            <li><a href="{{ url_for('auth.edit_profile') }}" class="sidebar-btn">Edit Profile</a></li>
            <li><a href="{{ url_for('auth.logout') }}" class="sidebar-btn logout-btn">Logout</a></li>
          </ul>

        <!-- DOCTOR MENU -->
        {% elif session.role == 'doctor' %}
          <ul>
            <li><a href="{{ url_for('doctor.doctor_dashboard') }}" class="sidebar-btn">Dashboard</a></li>
            <li><a href="{{ url_for('doctor.doctor_report') }}" class="sidebar-btn">My Report</a></li>
            <li><a href="{{ url_for('doctor.view_announcements') }}" class="sidebar-btn">Announcements</a></li>
            <li><a href="{{ url_for('auth.edit_profile') }}" class="sidebar-btn">Edit Profile</a></li>
            <li><a href="{{ url_for('auth.logout') }}" class="sidebar-btn logout-btn">Logout</a></li>
          </ul>

        <!-- NURSE MENU -->
        {% elif session.role == 'nurse' %}
          <ul>
            <li><a href="{{ url_for('nurse.nurse_dashboard') }}" class="sidebar-btn">Dashboard</a></li>
            <li><a href="{{ url_for('nurse.view_announcements') }}" class="sidebar-btn">Announcements</a></li>
            <li><a href="{{ url_for('auth.edit_profile') }}" class="sidebar-btn">Edit Profile</a></li>
            <li><a href="{{ url_for('auth.logout') }}" class="sidebar-btn logout-btn">Logout</a></li>
          </ul>

        <!-- MANAGER MENU -->
        {% elif session.role == 'manager' %}
          <ul>
            <li><a href="{{ url_for('manager.manager_dashboard') }}" class="sidebar-btn">Dashboard</a></li>
            <li><a href="{{ url_for('manager.inventory') }}" class="sidebar-btn">Inventory</a></li>
            <li><a href="{{ url_for('manager.executive_report') }}" class="sidebar-btn">Executive Report</a></li>
            <li><a href="{{ url_for('manager.manage_staff') }}" class="sidebar-btn">Manage Staff</a></li>
            <li><a href="{{ url_for('manager.staff_schedule') }}" class="sidebar-btn">Staff Schedule</a></li>
            <li><a href="{{ url_for('manager.announcements') }}" class="sidebar-btn">Announcements</a></li>
            <li><a href="{{ url_for('manager.download_guide') }}" class="sidebar-btn">Download Guide</a></li>
            <li><a href="{{ url_for('auth.edit_profile') }}" class="sidebar-btn">Edit Profile</a></li>
            <li><a href="{{ url_for('auth.logout') }}" class="sidebar-btn logout-btn">Logout</a></li>
          </ul>

        <!-- ADMIN MENU -->
        {% elif session.role == 'admin' %}
          <ul>
            <li><a href="{{ url_for('admin.admin_dashboard') }}" class="sidebar-btn">Dashboard</a></li>
            <li><a href="{{ url_for('admin.manage_users') }}" class="sidebar-btn">Manage Users</a></li>
            <li><a href="{{ url_for('admin.system_settings') }}" class="sidebar-btn">System Settings</a></li>
            <li><a href="{{ url_for('admin.doctor_report') }}" class="sidebar-btn">Doctor Report</a></li>
            <li><a href="{{ url_for('admin.announcements') }}" class="sidebar-btn">Announcements</a></li>
            <li><a href="{{ url_for('auth.edit_profile') }}" class="sidebar-btn">Edit Profile</a></li>
            <li><a href="{{ url_for('auth.logout') }}" class="sidebar-btn logout-btn">Logout</a></li>
          </ul>
        {% endif %}

        <!-- Theme Toggle — FULLY ACCESSIBLE -->
        <div class="theme-toggle-wrapper p-4 border-t border-gray-300 mt-4">
          <label class="switch" for="darkModeToggle" aria-label="Toggle dark mode">
            <input 
              type="checkbox" 
              id="darkModeToggle" 
              aria-label="Dark mode toggle"
              title="Toggle dark mode on/off"
            >
            <span class="slider round" aria-hidden="true"></span>
          </label>
          <span class="ml-3 text-sm font-medium">Dark Mode</span>
        </div>

      {% else %}
        <!-- NOT LOGGED IN -->
        <ul class="text-center mt-8">
          <li><a href="{{ url_for('public.login_page') }}" class="btn btn-primary">Staff Login</a></li>
          <li class="mt-4"><a href="{{ url_for('public.home') }}" class="text-blue-600 hover:underline">← Back to Public Site</a></li>
        </ul>
      {% endif %}
    </nav>
  </aside>

  <!-- Main Content -->
  <main class="dashboard" id="main-content">
    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-messages">
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
              {{ message }}
              <button class="close" onclick="this.parentElement.remove()">X</button>
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}
    {% block content %}{% endblock %}
  </main>

  <div class="sidebar-overlay" id="sidebar-overlay"></div>

  <!-- Scripts -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const toggle = document.getElementById('darkModeToggle');
      if (!toggle) return;

      // Restore from localStorage
      const savedTheme = localStorage.getItem('theme') || 'light';
      document.documentElement.dataset.theme = savedTheme;
      toggle.checked = savedTheme === 'dark';

      toggle.addEventListener('change', () => {
        const newTheme = toggle.checked ? 'dark' : 'light';
        document.documentElement.dataset.theme = newTheme;
        localStorage.setItem('theme', newTheme);

        // Sync with backend if logged in
        const userId = document.body.dataset.userId;
        if (userId) {
          const csrfToken = document.querySelector('meta[name="csrf-token"]')?.content || '';
          fetch('/change_theme', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrfToken
            },
            body: 'theme=' + encodeURIComponent(newTheme)
          }).catch(() => {});
        }
      });
    });

    // Sidebar logic
    function initSidebar() {
      const toggleBtn = document.getElementById('menu-toggle-btn');
      const sidebar = document.getElementById('sidebar');
      const mainContent = document.getElementById('main-content');
      const overlay = document.getElementById('sidebar-overlay');
      if (!toggleBtn || !sidebar || !mainContent || !overlay) return;

      let isOpen = sidebar.classList.contains('active');
      toggleBtn.setAttribute('aria-expanded', isOpen);

      function toggleSidebar() {
        isOpen = !isOpen;
        sidebar.classList.toggle('active', isOpen);
        mainContent.classList.toggle('active', isOpen);
        overlay.classList.toggle('active', isOpen);
        toggleBtn.setAttribute('aria-expanded', isOpen);
      }

      toggleBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
      document.addEventListener('keydown', e => e.key === 'Escape' && isOpen && toggleSidebar());

      if ('{{ session.get("role") }}' === 'receptionist') {
        setTimeout(toggleSidebar, 100);
      }
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initSidebar);
    } else {
      initSidebar();
    }
  </script>

  <script src="{{ url_for('static', filename='js/defaultPage.js') }}?v=1"></script>
  {% if session.role == 'receptionist' %}
    <script src="{{ url_for('static', filename='js/reception.js') }}?v=2"></script>
  {% elif session.role == 'doctor' %}
    <script src="{{ url_for('static', filename='js/doctorDashboard.js') }}?v=1"></script>
  {% elif session.role == 'nurse' %}
    <script src="{{ url_for('static', filename='js/nurseDashboard.js') }}?v=1"></script>
  {% elif session.role == 'admin' %}
    <script src="{{ url_for('static', filename='js/admin.js') }}?v=1"></script>
  {% elif session.role == 'manager' %}
    <script src="{{ url_for('static', filename='js/manager.js') }}?v=2"></script>
  {% endif %}
  {% block scripts %}{% endblock %}
</body>
</html>