{% extends "homepage/base2.html" %}
{% block title %}Medi-Assist™ - Book Appointment{% endblock %}
{% block body_class %}book-appointment-page{% endblock %}

{% block content %}
<div class="card">
    <h1>Book an Appointment</h1>

    <!-- EMERGENCY TOGGLE -->
    <div class="emergency-toggle mb-6 p-4 bg-red-50 border border-red-300 rounded-lg">
        <label class="switch inline-flex items-center" for="emergencyMode">
        <input type="checkbox" id="emergencyMode" name="emergencyMode" aria-checked="false" aria-label="Emergency toggle">
        <span class="slider round"></span>
        <span id="emergencyLabel" class="ml-3 text-lg font-bold text-red-700">Emergency — Request Ambulance Now</span>
        </label>

<span id="emergencyLabel" class="ml-3 text-lg font-bold text-red-700">
    Emergency — Request Ambulance Now
</span>

        <p class="text-sm text-red-600 mt-2">Enable only if you need immediate medical help and ambulance dispatch</p>
    </div>

    <form method="POST" action="" novalidate id="appointmentForm">
        {{ form.hidden_tag() }}

        <!-- Hidden field for emergency -->
        <input type="hidden" name="is_emergency" id="isEmergencyField" value="0">

        <div class="form-group">
            {{ form.patient_name.label(class="form-label") }}
            {{ form.patient_name(class="form-control", placeholder="Full Name", required=True) }}
            {% for error in form.patient_name.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.patient_phone.label(class="form-label") }}
            {{ form.patient_phone(class="form-control", placeholder="Phone Number (Required for emergency)", required=True) }}
            {% for error in form.patient_phone.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.patient_email.label(class="form-label") }}
            {{ form.patient_email(class="form-control", placeholder="Email (for confirmation)", required=True) }}
            {% for error in form.patient_email.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <!-- EMERGENCY LOCATION (shown only in emergency mode) -->
        <div id="emergencyLocationGroup" class="form-group hidden">
            <label class="form-label text-red-700 font-bold">
                <i class="fas fa-map-marker-alt"></i> Your Current Location <span class="text-danger">*</span>
            </label>
            <div class="flex gap-2">
                <input type="text" id="locationInput" class="form-control" placeholder="Getting your location..." disabled>
                <button type="button" id="getLocationBtn" class="btn btn-danger">
                    <i class="fas fa-location-arrow"></i> Get Location
                </button>
            </div>
            <input type="hidden" name="latitude" id="latitude">
            <input type="hidden" name="longitude" id="longitude">
            <small class="text-red-600">Ambulance will be dispatched to this GPS location</small>
        </div>

        <div class="form-group">
            {{ form.date.label(class="form-label") }}
            {{ form.date(class="form-control", type="datetime-local") }}
            {% for error in form.date.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            {{ form.reason.label(class="form-label") }}
            {{ form.reason(class="form-control", placeholder="Reason for visit (e.g. chest pain, bleeding, difficulty breathing)", rows=3) }}
            {% for error in form.reason.errors %}
                <span class="text-danger">{{ error }}</span>
            {% endfor %}
        </div>

        <div class="form-group">
            <label for="doctorSelect" class="form-label">Doctor <span class="text-danger">*</span></label>
            <select name="doctor" id="doctorSelect" class="form-control" required 
                    aria-label="Select Doctor" title="Choose your preferred doctor">
                <option value="">Select a Doctor</option>
                {% for doctor in doctors %}
                    <option value="{{ doctor.staff_number }}">
                        Dr. {{ doctor.first_name }} {{ doctor.last_name }} 
                        {% if doctor.specialty %}({{ doctor.specialty }}){% endif %}
                    </option>
                {% endfor %}
            </select>
        </div>

        <div class="form-group">
            {{ form.submit(class="btn btn-primary w-full", value="Book Appointment") }}
        </div>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/success-popup.js') }}"></script>
<script>
// Emergency Mode + GPS + Accessibility Fix
document.addEventListener('DOMContentLoaded', () => {
    const emergencyToggle = document.getElementById('emergencyMode');
    const emergencyGroup = document.getElementById('emergencyLocationGroup');
    const isEmergencyField = document.getElementById('isEmergencyField');
    const getLocationBtn = document.getElementById('getLocationBtn');
    const locationInput = document.getElementById('locationInput');
    const submitBtn = document.querySelector('button[type="submit"]');

    // Toggle emergency mode
    emergencyToggle.addEventListener('change', function() {
        const isEmergency = this.checked;
        emergencyGroup.classList.toggle('hidden', !isEmergency);
        isEmergencyField.value = isEmergency ? '1' : '0';

        if (isEmergency) {
            submitBtn.value = "CALL AMBULANCE NOW";
            submitBtn.classList.add('btn-danger');
            document.querySelector('h1').textContent = "Emergency Request";
            document.getElementById('popupTitle').textContent = "EMERGENCY HELP DISPATCHED!";
            document.getElementById('popupMessage').textContent = "Ambulance is on the way to your location.";
            document.getElementById('emergencyWarning').classList.remove('hidden');
        } else {
            submitBtn.value = "Book Appointment";
            submitBtn.classList.remove('btn-danger');
            document.querySelector('h1').textContent = "Book an Appointment";
        }
    });

    // Get GPS Location
    getLocationBtn.addEventListener('click', () => {
        if (!navigator.geolocation) {
            alert("Geolocation is not supported by your browser");
            return;
        }

        getLocationBtn.disabled = true;
        getLocationBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Locating...';
        locationInput.value = "Finding your location...";

        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lng = position.coords.longitude;
                document.getElementById('latitude').value = lat;
                document.getElementById('longitude').value = lng;

                // Reverse geocode (optional - shows address)
                fetch(`https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lng}&format=json`)
                    .then(r => r.json())
                    .then(data => {
                        locationInput.value = data.display_name || `Lat: ${lat}, Lng: ${lng}`;
                    })
                    .catch(() => {
                        locationInput.value = `GPS: ${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                    });

                getLocationBtn.innerHTML = '<i class="fas fa-check"></i> Location Captured';
            },
            (error) => {
                locationInput.value = "Location access denied or failed";
                getLocationBtn.innerHTML = '<i class="fas fa-location-arrow"></i> Retry';
                getLocationBtn.disabled = false;
                alert("Please allow location access to dispatch ambulance");
            },
            { timeout: 10000, enableHighAccuracy: true }
        );
    });
});
</script>
{% endblock %}