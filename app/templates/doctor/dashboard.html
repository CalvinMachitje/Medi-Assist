{% extends "base.html" %}
{% block title %}Doctor Dashboard - Medi-Assist™{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/doctor.css') }}?v=3">
{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8 doctor-dash-container">
    <header class="doctor-dash-header mb-8 text-center">
        <h2 class="text-4xl font-bold text-primary">Dr. {{ current_user.first_name }} {{ current_user.last_name }}</h2>
        <p class="text-xl text-gray-600 mt-2">Welcome back • {{ now.strftime('%A, %B %d, %Y') }}</p>
    </header>

    <!-- Today's Appointments -->
    <section class="bg-white rounded-xl shadow-lg p-8 mb-8">
        <h3 class="text-2xl font-bold mb-6 flex items-center gap-3">
            <i class="fas fa-calendar-check text-blue-600"></i> Today's Appointments ({{ patients_today|length }})
        </h3>
        {% if patients_today %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for p in patients_today %}
            <div class="border-l-4 border-blue-500 pl-4 py-3 bg-gray-50 rounded-r-lg hover:shadow-md transition">
                <div class="font-semibold text-lg">{{ p.patient_name }}</div>
                <div class="text-sm text-gray-600">ID: {{ p.patient_id }}</div>
                <div class="text-sm">Time: {{ p.appointment_time or 'Any Time' }}</div>
                <div class="mt-3">
                    <a href="{{ url_for('doctor.view_patient', patient_id=p.patient_id) }}" 
                       class="btn btn-primary btn-sm">View Profile</a>
                    <a href="{{ url_for('doctor.prescription_page', patient_id=p.patient_id) }}" 
                       class="btn btn-success btn-sm ml-2">Prescribe</a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p class="text-center text-gray-500 py-8 text-lg">No appointments scheduled for today.</p>
        {% endif %}
    </section>

    <!-- Quick Stats -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-8">
        <div class="stat-card text-center p-6 bg-gradient-to-br from-blue-500 to-blue-600 text-white rounded-xl">
            <div class="text-3xl font-bold">{{ total_patients }}</div>
            <div>Total Patients</div>
        </div>
        <div class="stat-card text-center p-6 bg-gradient-to-br from-green-500 to-green-600 text-white rounded-xl">
            <div class="text-3xl font-bold">{{ chronic_patients }}</div>
            <div>Chronic Cases</div>
        </div>
        <div class="stat-card text-center p-6 bg-gradient-to-br from-orange-500 to-red-600 text-white rounded-xl">
            <div class="text-3xl font-bold">{{ pending_lab_results|default(0) }}</div>
            <div>Pending Labs</div>
        </div>
        <div class="stat-card text-center p-6 bg-gradient-to-br from-purple-500 to-purple-700 text-white rounded-xl">
            <div class="text-3xl font-bold">{{ unread_messages|default(0) }}</div>
            <div>Messages</div>
        </div>
    </section>

    <!-- Patient Search -->
    <section class="bg-white rounded-xl shadow-lg p-8">
        <h3 class="text-2xl font-bold mb-6">Patient Directory</h3>
        <input type="text" id="searchInput" placeholder="Search by name, ID, or phone..." 
               class="w-full p-4 border rounded-lg text-lg" onkeyup="filterPatients()">
        <div class="mt-6 overflow-x-auto">
            <table id="patientsTable" class="w-full table-auto">
                <thead class="bg-gray-100">
                    <tr>
                        <th class="px-4 py-3 text-left">ID</th>
                        <th class="px-4 py-3 text-left">Name</th>
                        <th class="px-4 py-3 text-left">Gender</th>
                        <th class="px-4 py-3 text-left">Last Visit</th>
                        <th class="px-4 py-3 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for p in patients %}
                    <tr class="hover:bg-gray-50 transition">
                        <td class="px-4 py-3">{{ p.id }}</td>
                        <td class="px-4 py-3 font-medium">{{ p.first_name }} {{ p.last_name }}</td>
                        <td class="px-4 py-3">{{ p.gender|title }}</td>
                        <td class="px-4 py-3">{{ p.last_visit_date or 'Never' }}</td>
                        <td class="px-4 py-3">
                            <a href="{{ url_for('doctor.view_patient', patient_id=p.id) }}" class="text-blue-600 hover:underline">View</a>
                            <span class="mx-2">•</span>
                            <a href="{{ url_for('doctor.prescription_page', patient_id=p.id) }}" class="text-green-600 hover:underline">Prescribe</a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </section>
</div>

<script>
function filterPatients() {
    const input = document.getElementById("searchInput").value.toLowerCase();
    const rows = document.querySelectorAll("#patientsTable tbody tr");
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(input) ? "" : "none";
    });
}
</script>
{% endblock %}