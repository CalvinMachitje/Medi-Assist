{% extends 'base.html' %}
{% block title %}Manage Appointments - Medi-Assistâ„¢{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reception.css') }}?v=2">
{% endblock %}
{% block content %}
<div class="dashboard-content">
    <h2 class="text-3xl font-bold mb-8">Manage Appointments</h2>

    <!-- Flash Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, msg in messages %}
                <div class="flash-message {{ category }}">{{ msg }}</div>
            {% endfor %}
        {% endif %}
    {% endwith %}

    <!-- Booking Section -->
    <div class="card">
        <h3 class="text-2xl font-semibold mb-4">Book New Appointment</h3>
        <form id="bookingForm" onsubmit="bookAppointment(event)">
            <input type="hidden" name="action" value="book_appointment">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <div class="form-group">
                <label for="patientId">Patient *</label>
                <select id="patientId" name="patient_id" class="form-control" required>
                    <option value="">Select a patient</option>
                    {% for patient in patients %}
                        <option value="{{ patient.id }}"
                            {% if selected_patient_id and selected_patient_id == patient.id|string %}selected{% endif %}>
                            {{ patient.name }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            <div class="form-group">
                <label for="appointmentTime">Appointment Date & Time</label>
                <input type="datetime-local" id="appointmentTime" name="appointment_time" class="form-control" required />
            </div>
            <div class="form-group">
                <label for="reasonInput">Reason (optional)</label>
                <input type="text" id="reasonInput" name="reason" class="form-control" placeholder="Reason for appointment" />
            </div>
            <div class="form-group">
                <label for="helperId">Assign Staff (optional)</label>
                <select id="helperId" name="helper_id" class="form-control">
                    <option value="">None</option>
                    {% for staff in available_staff %}
                        <option value="{{ staff.id }}">{{ staff.name }} ({{ staff.role }})</option>
                    {% endfor %}
                </select>
            </div>
            <button type="submit" class="btn btn-primary">Book Appointment</button>
            <div id="formMessage" class="mt-4"></div>
        </form>
    </div>

    <!-- Self-Booked Table -->
    {% if self_booked_appointments %}
        {% for appt in self_booked_appointments %}
            <tr>
                <td>{{ appt.id }}</td>
                <td>{{ appt.patient_name }}</td>
                <td>{{ appt.patient_phone | default('N/A') }}</td>
                <td>{{ appt.patient_email | default('N/A') }}</td>
                <td>{{ appt.appointment_date }}</td>
                <td>{{ appt.reason }}</td>
                <td>
                    <form class="convertForm" data-id="{{ appt.id }}" onsubmit="convertSelfBooked(event)">
                        <input type="hidden" name="action" value="convert_self_booked">
                        <input type="hidden" name="self_booked_id" value="{{ appt.id }}">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <select name="patient_id" class="form-control" required>
                            <option value="">Select Patient</option>
                            {% for patient in patients %}
                                <option value="{{ patient.id }}">{{ patient.name }}</option>
                            {% endfor %}
                        </select>
                        <input type="datetime-local" name="appointment_time" value="{{ appt.appointment_date | replace(' ', 'T') }}" class="form-control" required>
                        <input type="text" name="reason" value="{{ appt.reason }}" class="form-control">
                        <select name="helper_id" class="form-control" required>
                            <option value="">Assign Staff</option>
                            {% for staff in available_staff %}
                                <option value="{{ staff.id }}">{{ staff.name }} ({{ staff.role }})</option>
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-primary">Confirm</button>
                    </form>
                </td>
            </tr>
        {% endfor %}
    {% else %}
        <tr><td colspan="7" class="text-center text-muted">No pending self-booked appointments</td></tr>
    {% endif %}

    <!-- Filter for appointment status -->
    <div class="mt-8">
        <label for="statusFilter" class="font-semibold mb-2 block">Filter by Status:</label>
        <select id="statusFilter" class="form-control max-w-xs">
            <option value="all">All</option>
            <option value="open">Open (scheduled/waiting)</option>
            <option value="rescheduled">Rescheduled</option>
            <option value="missed">Missed</option>
            <option value="cancelled">Cancelled</option>
        </select>
    </div>

    <script>
    function bookAppointment(e) {
        e.preventDefault();
        const form = e.target;
        const data = new FormData(form);
        fetch(form.action, {
            method: 'POST',
            body: data,
            headers: { 'X-Requested-With': 'XMLHttpRequest' }
        })
        .then(r => r.json())
        .then(resp => {
            const msg = document.getElementById('formMessage');
            msg.innerHTML = `<div class="alert alert-${resp.success ? 'success' : 'danger'}">${resp.message}</div>`;
            if (resp.success) setTimeout(() => location.reload(), 1000);
        });
    }

    function convertSelfBooked(e) {
        e.preventDefault();
        const form = e.target;
        const data = new FormData(form);
        fetch('/manage_appointments', { method: 'POST', body: data })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message);
            if (resp.success) location.reload();
        });
    }

    function cancelAppointment(e) {
        e.preventDefault();
        if (!confirm('Cancel this appointment?')) return;
        const form = e.target;
        const data = new FormData(form);
        fetch('/manage_appointments', { method: 'POST', body: data })
        .then(r => r.json())
        .then(resp => {
            alert(resp.message);
            if (resp.success) location.reload();
        });
    }
</script>
</div>
{% endblock %}